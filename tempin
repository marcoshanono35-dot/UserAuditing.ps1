$acclist = @("jmoney", "plinktern") | ForEach-Object { $_.Trim().ToLower() }

# Get all AD users (enabled or disabled), convert names to lowercase
$acc = Get-ADUser -Filter * -Properties SamAccountName |
        Select-Object -ExpandProperty SamAccountName |
        ForEach-Object { $_.Trim().ToLower() }

foreach ($user in $acc) {
    if ($user -notin $acclist) {
        Disable-ADAccount -Identity $user
        Write-Host "Disabled AD account: $user"
    }
}


# Bind directly to the krbtgt account (no AD cmdlet restrictions)
$krbtgt = [ADSI]"LDAP://cn=krbtgt,cn=Users,dc=mindmend,dc=ai"

# Read current userAccountControl
$uac = $krbtgt.userAccountControl[0]

# Clear the DISABLED flag (0x2)
$newUac = $uac -band (-bnot 2)

# Write the new value
$krbtgt.userAccountControl = $newUac
$krbtgt.CommitChanges()

Write-Host "krbtgt account has been re-enabled."
