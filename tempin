$acclist = @("athena","ajohnson","achi","anguyen","kliu","jsmith","dgonzalez","krbtgt", "DefaultAccount", "Guest", "WDAGUtilityAccount") | ForEach-Object { $_.Trim().ToLower() }

# Get all AD users (enabled or disabled), convert names to lowercase
$acc = Get-ADUser -Filter * -Properties SamAccountName |
        Select-Object -ExpandProperty SamAccountName |
        ForEach-Object { $_.Trim().ToLower() }

foreach ($user in $acc) {
    if ($user -notin $acclist) {
        Disable-ADAccount -Identity $user
        Write-Host "Disabled AD account: $user"
    }
}


nltest /dsgetdc:YOURDOMAIN


Get-ADUser -Filter 'SamAccountName -like "krbtgt*"' -Properties Enabled,DistinguishedName



$krb = Get-ADUser -Filter { SamAccountName -eq "krbtgt" } -Properties DistinguishedName,userAccountControl
$dn = $krb.DistinguishedName

$krb = Get-ADUser -Filter { SamAccountName -eq "krbtgt" } -Properties DistinguishedName,userAccountControl
$dn  = $krb.DistinguishedName



$entry = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$dn")
$uac   = $entry.Properties["userAccountControl"].Value
$newUac = $uac -band (-bnot 2)   # Remove disabled bit
$entry.Properties["userAccountControl"].Value = $newUac
$entry.CommitChanges()

Write-Host "krbtgt successfully enabled"


$entry = [ADSI]("LDAP://$dn")

$krb | Select SamAccountName, AdminCount, Enabled

